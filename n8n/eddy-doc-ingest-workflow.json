{"updatedAt":"2026-02-09T20:55:16.918Z","createdAt":"2026-02-09T11:46:53.727Z","id":"z4re03A65oXIt7Wz","name":"EDDY Doc Ingest","description":null,"active":true,"isArchived":false,"nodes":[{"parameters":{},"name":"Manual Trigger","type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[100,400],"id":"727dd4e0-547e-414e-95e2-8a23d734d892"},{"parameters":{"httpMethod":"POST","path":"eddy/doc-ingest","responseMode":"responseNode","options":{"allowedOrigins":"*"}},"name":"ğŸŒ Webhook Ingest","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[100,700],"webhookId":"eddy-doc-ingest-00000010","id":"f5d9864e-fcd1-45a4-9973-08aa90ecb9bd"},{"parameters":{"jsCode":"// Scan /home/node/eddy-inbox/pending/ fÃ¼r neue Dokumente\nconst fs = require('fs');\nconst path = require('path');\nconst crypto = require('crypto');\n\nconst INBOX_DIR = '/home/node/eddy-inbox/pending';\nconst SUPPORTED_TYPES = ['.pdf', '.txt', '.md', '.docx'];\n\ntry {\n  if (!fs.existsSync(INBOX_DIR)) {\n    return [{ json: { error: 'Inbox directory not found', path: INBOX_DIR, files: [] } }];\n  }\n\n  const files = fs.readdirSync(INBOX_DIR)\n    .filter(f => {\n      const ext = path.extname(f).toLowerCase();\n      return SUPPORTED_TYPES.includes(ext) && !f.startsWith('.');\n    })\n    .map(f => {\n      const filePath = path.join(INBOX_DIR, f);\n      const stats = fs.statSync(filePath);\n      const fileBuffer = fs.readFileSync(filePath);\n      const fileHash = crypto.createHash('sha256').update(fileBuffer).digest('hex');\n      const ext = path.extname(f).toLowerCase().replace('.', '');\n      \n      return {\n        json: {\n          fileName: f,\n          filePath: filePath,\n          sourceType: ext,\n          fileHash: fileHash,\n          fileSize: stats.size,\n          modifiedAt: stats.mtime.toISOString()\n        }\n      };\n    });\n\n  if (files.length === 0) {\n    return [{ json: { status: 'empty', message: 'No new files in inbox' } }];\n  }\n\n  return files;\n} catch (err) {\n  return [{ json: { error: err.message } }];\n}"},"name":"ğŸ“‚ Scan Inbox","type":"n8n-nodes-base.code","typeVersion":2,"position":[340,400],"id":"4a4defd7-9a41-4f2f-9280-fce1e64b6cd0"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose"},"combinator":"and","conditions":[{"leftValue":"={{ $json.fileName }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}]},"looseTypeValidation":true},"name":"ğŸ“‹ Has Files?","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[560,400],"id":"389d0d2c-d898-42f9-89f7-66e593216278"},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM check_file_ingested($1);","options":{"queryReplacement":"={{ [$json.fileHash] }}"}},"name":"ğŸ” Duplikat-Check","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[780,400],"credentials":{"postgres":{"id":"Jq2IeHXVMOnpk0fI","name":"eddy-knowledge-postgres"}},"id":"a9113e43-9ecc-40cf-9d3f-72a1120c712d"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"combinator":"and","conditions":[{"leftValue":"={{ $json.is_ingested }}","rightValue":true,"operator":{"type":"boolean","operation":"notTrue"}}]}},"name":"ğŸ†• Noch nicht ingestiert?","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1000,400],"id":"9e35ee71-f7c4-4d20-8119-c05abcc21ab7"},{"parameters":{"jsCode":"// Text-Extraktion basierend auf Dateityp\nconst fs = require('fs');\nconst { execSync } = require('child_process');\n\nconst filePath = $('ğŸ“‹ Has Files?').first().json.filePath;\nconst sourceType = $('ğŸ“‹ Has Files?').first().json.sourceType;\nconst fileName = $('ğŸ“‹ Has Files?').first().json.fileName;\nconst fileHash = $('ğŸ“‹ Has Files?').first().json.fileHash;\nconst modifiedAt = $('ğŸ“‹ Has Files?').first().json.modifiedAt;\n\nlet content = '';\n\ntry {\n  if (sourceType === 'txt' || sourceType === 'md') {\n    content = fs.readFileSync(filePath, 'utf-8');\n  } else if (sourceType === 'pdf') {\n    // pdf-parse in eigenem Node-Prozess (n8n Sandbox freezt Prototypen)\n    const result = execSync(\n      'node /home/node/eddy-inbox/scripts/pdf-extract.js \"' + filePath.replace(/\"/g, '\\\\\"') + '\"',\n      { timeout: 30000, encoding: 'utf-8', maxBuffer: 10 * 1024 * 1024 }\n    );\n    const parsed = JSON.parse(result.trim());\n    if (parsed.error) throw new Error('PDF parse: ' + parsed.error);\n    content = parsed.text || '';\n  } else if (sourceType === 'docx') {\n    content = '[DOCX extraction not yet supported]';\n  }\n\n  if (!content || content.trim().length < 10) {\n    return [{ json: { error: 'No content extracted', fileName, sourceType } }];\n  }\n\n  return [{\n    json: {\n      content: content.trim(),\n      fileName, filePath, sourceType, fileHash, modifiedAt,\n      contentLength: content.trim().length\n    }\n  }];\n} catch (err) {\n  return [{ json: { error: err.message, fileName, sourceType } }];\n}"},"name":"ğŸ“„ Text Extraction","type":"n8n-nodes-base.code","typeVersion":2,"position":[1220,400],"id":"34de3c90-2b5b-4125-9935-61cb42459a41"},{"parameters":{"jsCode":"// Chunking mit Overlap\nconst CHUNK_SIZE = 500;     // ~500 Token\nconst OVERLAP = 100;        // ~200 Token\n\nconst content = $json.content || '';\nconst fileName = $json.fileName;\nconst sourceType = $json.sourceType;\nconst fileHash = $json.fileHash;\nconst modifiedAt = $json.modifiedAt;\n\nconst crypto = require('crypto');\n\nif (!content || content.length < 10) {\n  return [{ json: { error: 'No content to chunk', fileName } }];\n}\n\nconst chunks = [];\nlet startIndex = 0;\nlet chunkIndex = 0;\n\nwhile (startIndex < content.length) {\n  let endIndex = Math.min(startIndex + CHUNK_SIZE, content.length);\n  \n  // Versuche am Satzende zu brechen\n  if (endIndex < content.length) {\n    const lastPeriod = content.lastIndexOf('.', endIndex);\n    const lastNewline = content.lastIndexOf('\\n', endIndex);\n    const breakPoint = Math.max(lastPeriod, lastNewline);\n    if (breakPoint > startIndex + CHUNK_SIZE * 0.5) {\n      endIndex = breakPoint + 1;\n    }\n  }\n  \n  const chunkText = content.slice(startIndex, endIndex).trim();\n  \n  if (chunkText.length > 20) {\n    const chunkHash = crypto.createHash('sha256').update(chunkText).digest('hex');\n    chunks.push({\n      json: {\n        chunk_content: chunkText,\n        chunk_hash: chunkHash,\n        chunk_index: chunkIndex,\n        source_file: fileName,\n        source_type: sourceType,\n        file_hash: fileHash,\n        modified_at: modifiedAt\n      }\n    });\n    chunkIndex++;\n  }\n  \n  if (endIndex >= content.length) break;\n  startIndex = endIndex - OVERLAP;\n}\n\nconst totalChunks = chunks.length;\nchunks.forEach(c => c.json.total_chunks = totalChunks);\n\nreturn chunks;"},"name":"ğŸ”ª Chunking (800/320)","type":"n8n-nodes-base.code","typeVersion":2,"position":[1440,400],"id":"283113a0-6323-48a7-9762-8e53a2f63355"},{"parameters":{"method":"POST","url":"http://n8n-ollama:11434/api/embeddings","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ model: 'mxbai-embed-large', prompt: 'search_document: ' + $json.chunk_content }) }}","options":{"timeout":900000,"retryOnFailure":true,"maxRetries":3,"waitBetweenRetries":5000}},"name":"ğŸ§¬ Embedding (mxbai)","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2000,300],"id":"78467c42-1ba9-4e5c-adc2-063e3296db8b"},{"parameters":{"operation":"executeQuery","query":"INSERT INTO document_chunks (content, content_hash, embedding, source_file, source_type, file_hash, chunk_index, total_chunks, source_modified_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9) ON CONFLICT (content_hash) DO NOTHING RETURNING id;","options":{"queryReplacement":"={{ [$node['ğŸ”„ Batch Loop'].json.chunk_content, $node['ğŸ”„ Batch Loop'].json.chunk_hash, '[' + $json.embedding.join(',') + ']', $node['ğŸ”„ Batch Loop'].json.source_file, $node['ğŸ”„ Batch Loop'].json.source_type, $node['ğŸ”„ Batch Loop'].json.file_hash, $node['ğŸ”„ Batch Loop'].json.chunk_index, $node['ğŸ”„ Batch Loop'].json.total_chunks, $node['ğŸ”„ Batch Loop'].json.modified_at] }}"}},"name":"ğŸ’¾ Store in pgvector","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[2200,300],"credentials":{"postgres":{"id":"Jq2IeHXVMOnpk0fI","name":"eddy-knowledge-postgres"}},"id":"98c54b9f-074d-4739-88be-1c3888c9ed61"},{"parameters":{"jsCode":"// Datei von pending nach processed verschieben\nconst fs = require('fs');\nconst path = require('path');\n\nconst filePath = $('ğŸ“‹ Has Files?').first().json.filePath;\nconst fileName = $('ğŸ“‹ Has Files?').first().json.fileName;\nconst processedDir = '/home/node/eddy-inbox/processed';\n\ntry {\n  if (!fs.existsSync(processedDir)) {\n    fs.mkdirSync(processedDir, { recursive: true });\n  }\n  \n  const dest = path.join(processedDir, fileName);\n  fs.renameSync(filePath, dest);\n  \n  return [{\n    json: {\n      status: 'success',\n      fileName,\n      movedTo: dest,\n      chunks_created: $items().length\n    }\n  }];\n} catch (err) {\n  const failedDir = '/home/node/eddy-inbox/failed';\n  try {\n    if (!fs.existsSync(failedDir)) fs.mkdirSync(failedDir, { recursive: true });\n    fs.renameSync(filePath, path.join(failedDir, fileName));\n  } catch (e) { /* ignore */ }\n  \n  return [{ json: { status: 'error', error: err.message, fileName } }];\n}"},"name":"ğŸ“ Move to Processed","type":"n8n-nodes-base.code","typeVersion":2,"position":[2000,600],"id":"c95c59f6-3ca6-4482-8631-8ee07cd232f8"},{"parameters":{"jsCode":"// Webhook-Pfad: Content direkt chunken\nconst crypto = require('crypto');\n\nconst content = $json.body.content || '';\nconst metadata = $json.body.metadata || {};\nconst fileName = metadata.source_file || 'webhook-input';\nconst sourceType = metadata.source_type || 'txt';\nconst category = metadata.category || null;\nconst tags = metadata.tags || [];\nconst fileHash = crypto.createHash('sha256').update(content).digest('hex');\n\nconst CHUNK_SIZE = 500;\nconst OVERLAP = 100;\n\nif (!content || content.trim().length < 10) {\n  return [{ json: { error: 'No content provided' } }];\n}\n\nconst chunks = [];\nlet startIndex = 0;\nlet chunkIndex = 0;\nconst trimmed = content.trim();\n\nwhile (startIndex < trimmed.length) {\n  let endIndex = Math.min(startIndex + CHUNK_SIZE, trimmed.length);\n  \n  if (endIndex < trimmed.length) {\n    const lastPeriod = trimmed.lastIndexOf('.', endIndex);\n    const lastNewline = trimmed.lastIndexOf('\\n', endIndex);\n    const breakPoint = Math.max(lastPeriod, lastNewline);\n    if (breakPoint > startIndex + CHUNK_SIZE * 0.5) {\n      endIndex = breakPoint + 1;\n    }\n  }\n  \n  const chunkText = trimmed.slice(startIndex, endIndex).trim();\n  \n  if (chunkText.length > 20) {\n    const chunkHash = crypto.createHash('sha256').update(chunkText).digest('hex');\n    chunks.push({\n      json: {\n        chunk_content: chunkText,\n        chunk_hash: chunkHash,\n        chunk_index: chunkIndex,\n        source_file: fileName,\n        source_type: sourceType,\n        file_hash: fileHash,\n        category: category,\n        tags: tags\n      }\n    });\n    chunkIndex++;\n  }\n  \n  if (endIndex >= trimmed.length) break;\n  startIndex = endIndex - OVERLAP;\n}\n\nconst totalChunks = chunks.length;\nchunks.forEach(c => c.json.total_chunks = totalChunks);\n\nreturn chunks;"},"name":"ğŸ”ª Webhook Chunking","type":"n8n-nodes-base.code","typeVersion":2,"position":[560,850],"id":"d6bf7c64-b07c-411b-a583-ade8afc71816"},{"parameters":{"method":"POST","url":"http://n8n-ollama:11434/api/embeddings","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ model: 'mxbai-embed-large', prompt: 'search_document: ' + $json.chunk_content }) }}","options":{"timeout":300000}},"name":"ğŸ§¬ WH Embedding","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[780,850],"id":"440b24c4-74e6-41ba-bd0f-91bc6e070f9b"},{"parameters":{"operation":"executeQuery","query":"INSERT INTO document_chunks (content, content_hash, embedding, source_file, source_type, file_hash, chunk_index, total_chunks, category, tags) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10) ON CONFLICT (content_hash) DO NOTHING RETURNING id;","options":{"queryReplacement":"={{ [$node['ğŸ”ª Webhook Chunking'].json.chunk_content, $node['ğŸ”ª Webhook Chunking'].json.chunk_hash, '[' + $json.embedding.join(',') + ']', $node['ğŸ”ª Webhook Chunking'].json.source_file, $node['ğŸ”ª Webhook Chunking'].json.source_type, $node['ğŸ”ª Webhook Chunking'].json.file_hash, $node['ğŸ”ª Webhook Chunking'].json.chunk_index, $node['ğŸ”ª Webhook Chunking'].json.total_chunks, $node['ğŸ”ª Webhook Chunking'].json.category || null, $node['ğŸ”ª Webhook Chunking'].json.tags ? '{' + $node['ğŸ”ª Webhook Chunking'].json.tags.join(',') + '}' : null] }}"}},"name":"ğŸ’¾ WH Store","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[1000,850],"credentials":{"postgres":{"id":"Jq2IeHXVMOnpk0fI","name":"eddy-knowledge-postgres"}},"id":"8a0362d7-f1c6-4110-9e60-d3e9e413f854"},{"parameters":{"respondWith":"json","responseBody":"={{ $items().length > 0 && $node['ğŸ”ª Webhook Chunking'].first() ? { status: 'success', chunks_ingested: $items().length, source: $node['ğŸ”ª Webhook Chunking'].first().json.source_file || 'unknown' } : { status: 'error', message: 'No chunks created or missing source file' } }}","options":{}},"name":"âœ… WH Response","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1220,850],"id":"c2f848b1-57e3-42b7-8b0c-0ab9bccb8b1a"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"combinator":"and","conditions":[{"leftValue":"={{ $json.body.action }}","rightValue":"ask","operator":{"type":"string","operation":"equals"}}]}},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"combinator":"and","conditions":[{"leftValue":"={{ $json.body.action }}","rightValue":"ingest","operator":{"type":"string","operation":"equals"}}]}}]},"fallback":"output"},"id":"action-router-node","name":"ğŸ¯ Action Router","type":"n8n-nodes-base.switch","typeVersion":3,"position":[340,700]},{"parameters":{"method":"POST","url":"http://n8n-ollama:11434/api/embeddings","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ model: 'mxbai-embed-large', prompt: 'search_query: ' + $json.body.query }) }}","options":{"timeout":300000}},"id":"query-embed-node","name":"ğŸ” Query Embedding","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[560,600]},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM hybrid_search($1, $2, $3, $4, $5);","options":{"queryReplacement":"={{ ['[' + $json.embedding.join(',') + ']', $node['ğŸ¯ Action Router'].json.body.query, 5, 0.7, null] }}"}},"id":"hybrid-search-node","name":"ğŸ—„ï¸ Hybrid Search","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[780,600],"credentials":{"postgres":{"id":"Jq2IeHXVMOnpk0fI","name":"eddy-knowledge-postgres"}}},{"parameters":{"jsCode":"const items = $input.all();\nif (items.length === 0 || !items[0].json.content) {\n    return [{json: {context: \"Keine relevanten Informationen gefunden.\", query: $('ğŸ¯ Action Router').first().json.body.query}}];\n}\nconst context = items.map(item => `--- Dokument: ${item.json.source_file} ---\n${item.json.content}`).join('\\n\\n');\nconst query = $('ğŸ¯ Action Router').first().json.body.query;\nreturn [{ json: { context: context, query: query } }];"},"id":"context-format-node","name":"ğŸ“ Format Context","type":"n8n-nodes-base.code","typeVersion":2,"position":[1000,600]},{"parameters":{"method":"POST","url":"http://n8n-ollama:11434/api/generate","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ model: 'llama3.2', prompt: 'Du bist Eddy, ein technischer Assistent. Beantworte die Frage prÃ¤zise basierend auf dem folgenden Kontext. Wenn die Antwort nicht im Kontext steht, sage das ehrlich.\\n\\nKONTEXT:\\n' + $json.context + '\\n\\nFRAGE: ' + $json.query + '\\n\\nANTWORT:', stream: false }) }}","options":{"timeout":120000}},"id":"ollama-chat-node","name":"ğŸ¤– Ollama Chat","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1220,600]},{"parameters":{"respondWith":"json","responseBody":"={{ { answer: $json.response, context_used: $node['ğŸ“ Format Context'].json.context.length > 50 } }}","options":{}},"id":"ask-response-node","name":"ğŸ“¤ Ask Response","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1440,600]},{"parameters":{"batchSize":1,"options":{}},"id":"split-batches-node-v12","name":"ğŸ”„ Batch Loop","type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[1800,400]}],"connections":{"ğŸ“‚ Scan Inbox":{"main":[[{"node":"ğŸ“‹ Has Files?","type":"main","index":0}]]},"ğŸ“‹ Has Files?":{"main":[[{"node":"ğŸ” Duplikat-Check","type":"main","index":0}],[]]},"ğŸ” Duplikat-Check":{"main":[[{"node":"ğŸ†• Noch nicht ingestiert?","type":"main","index":0}]]},"ğŸ†• Noch nicht ingestiert?":{"main":[[],[{"node":"ğŸ“„ Text Extraction","type":"main","index":0}]]},"ğŸ“„ Text Extraction":{"main":[[{"node":"ğŸ”ª Chunking (800/320)","type":"main","index":0}]]},"ğŸŒ Webhook Ingest":{"main":[[{"node":"ğŸ¯ Action Router","type":"main","index":0}]]},"ğŸ”ª Webhook Chunking":{"main":[[{"node":"ğŸ§¬ WH Embedding","type":"main","index":0}]]},"ğŸ§¬ WH Embedding":{"main":[[{"node":"ğŸ’¾ WH Store","type":"main","index":0}]]},"ğŸ’¾ WH Store":{"main":[[{"node":"âœ… WH Response","type":"main","index":0}]]},"Manual Trigger":{"main":[[{"node":"ğŸ“‚ Scan Inbox","type":"main","index":0}]]},"ğŸ¯ Action Router":{"main":[[{"node":"ğŸ” Query Embedding","type":"main","index":0}],[{"node":"ğŸ”ª Webhook Chunking","type":"main","index":0}],[{"node":"ğŸ”ª Webhook Chunking","type":"main","index":0}]]},"ğŸ” Query Embedding":{"main":[[{"node":"ğŸ—„ï¸ Hybrid Search","type":"main","index":0}]]},"ğŸ—„ï¸ Hybrid Search":{"main":[[{"node":"ğŸ“ Format Context","type":"main","index":0}]]},"ğŸ“ Format Context":{"main":[[{"node":"ğŸ¤– Ollama Chat","type":"main","index":0}]]},"ğŸ¤– Ollama Chat":{"main":[[{"node":"ğŸ“¤ Ask Response","type":"main","index":0}]]},"ğŸ”ª Chunking (800/320)":{"main":[[{"node":"ğŸ”„ Batch Loop","type":"main","index":0}]]},"ğŸ”„ Batch Loop":{"main":[[{"node":"ğŸ“ Move to Processed","type":"main","index":0}],[{"node":"ğŸ§¬ Embedding (mxbai)","type":"main","index":0}]]},"ğŸ§¬ Embedding (mxbai)":{"main":[[{"node":"ğŸ’¾ Store in pgvector","type":"main","index":0}]]},"ğŸ’¾ Store in pgvector":{"main":[[{"node":"ğŸ”„ Batch Loop","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":{},"versionId":"4af0ed14-3ae2-4e67-be86-46310b3df4f6","activeVersionId":"4af0ed14-3ae2-4e67-be86-46310b3df4f6","versionCounter":110,"triggerCount":1,"shared":[{"updatedAt":"2026-02-09T11:46:53.727Z","createdAt":"2026-02-09T11:46:53.727Z","role":"workflow:owner","workflowId":"z4re03A65oXIt7Wz","projectId":"mLaDCKgRDTIf3aNP","project":{"updatedAt":"2026-01-31T22:40:11.437Z","createdAt":"2026-01-31T22:32:32.256Z","id":"mLaDCKgRDTIf3aNP","name":"Birger Baron <phlummi@gmail.com>","type":"personal","icon":null,"description":null,"creatorId":"cc1af505-66f4-4ef5-9b31-0821ef636557","projectRelations":[{"updatedAt":"2026-01-31T22:32:32.256Z","createdAt":"2026-01-31T22:32:32.256Z","userId":"cc1af505-66f4-4ef5-9b31-0821ef636557","projectId":"mLaDCKgRDTIf3aNP","user":{"updatedAt":"2026-02-09T20:22:30.770Z","createdAt":"2026-01-31T22:32:31.737Z","id":"cc1af505-66f4-4ef5-9b31-0821ef636557","email":"phlummi@gmail.com","firstName":"Birger","lastName":"Baron","personalizationAnswers":{"version":"v4","personalization_survey_submitted_at":"2026-01-31T22:40:21.666Z","personalization_survey_n8n_version":"2.4.8","companyType":"personal","reportedSource":"google"},"settings":{"userActivated":true,"firstSuccessfulWorkflowId":"DZ4nYMi6dWWISF6C","userActivatedAt":1770067150147,"easyAIWorkflowOnboarded":true,"npsSurvey":{"responded":true,"lastShownAt":1770390744317}},"disabled":false,"mfaEnabled":false,"lastActiveAt":"2026-02-09","isPending":false}}]}}],"tags":[],"activeVersion":{"updatedAt":"2026-02-09T20:55:16.919Z","createdAt":"2026-02-09T20:55:16.919Z","versionId":"4af0ed14-3ae2-4e67-be86-46310b3df4f6","workflowId":"z4re03A65oXIt7Wz","nodes":[{"parameters":{},"name":"Manual Trigger","type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[100,400],"id":"727dd4e0-547e-414e-95e2-8a23d734d892"},{"parameters":{"httpMethod":"POST","path":"eddy/doc-ingest","responseMode":"responseNode","options":{"allowedOrigins":"*"}},"name":"ğŸŒ Webhook Ingest","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[100,700],"webhookId":"eddy-doc-ingest-00000010","id":"f5d9864e-fcd1-45a4-9973-08aa90ecb9bd"},{"parameters":{"jsCode":"// Scan /home/node/eddy-inbox/pending/ fÃ¼r neue Dokumente\nconst fs = require('fs');\nconst path = require('path');\nconst crypto = require('crypto');\n\nconst INBOX_DIR = '/home/node/eddy-inbox/pending';\nconst SUPPORTED_TYPES = ['.pdf', '.txt', '.md', '.docx'];\n\ntry {\n  if (!fs.existsSync(INBOX_DIR)) {\n    return [{ json: { error: 'Inbox directory not found', path: INBOX_DIR, files: [] } }];\n  }\n\n  const files = fs.readdirSync(INBOX_DIR)\n    .filter(f => {\n      const ext = path.extname(f).toLowerCase();\n      return SUPPORTED_TYPES.includes(ext) && !f.startsWith('.');\n    })\n    .map(f => {\n      const filePath = path.join(INBOX_DIR, f);\n      const stats = fs.statSync(filePath);\n      const fileBuffer = fs.readFileSync(filePath);\n      const fileHash = crypto.createHash('sha256').update(fileBuffer).digest('hex');\n      const ext = path.extname(f).toLowerCase().replace('.', '');\n      \n      return {\n        json: {\n          fileName: f,\n          filePath: filePath,\n          sourceType: ext,\n          fileHash: fileHash,\n          fileSize: stats.size,\n          modifiedAt: stats.mtime.toISOString()\n        }\n      };\n    });\n\n  if (files.length === 0) {\n    return [{ json: { status: 'empty', message: 'No new files in inbox' } }];\n  }\n\n  return files;\n} catch (err) {\n  return [{ json: { error: err.message } }];\n}"},"name":"ğŸ“‚ Scan Inbox","type":"n8n-nodes-base.code","typeVersion":2,"position":[340,400],"id":"4a4defd7-9a41-4f2f-9280-fce1e64b6cd0"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose"},"combinator":"and","conditions":[{"leftValue":"={{ $json.fileName }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}]},"looseTypeValidation":true},"name":"ğŸ“‹ Has Files?","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[560,400],"id":"389d0d2c-d898-42f9-89f7-66e593216278"},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM check_file_ingested($1);","options":{"queryReplacement":"={{ [$json.fileHash] }}"}},"name":"ğŸ” Duplikat-Check","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[780,400],"credentials":{"postgres":{"id":"Jq2IeHXVMOnpk0fI","name":"eddy-knowledge-postgres"}},"id":"a9113e43-9ecc-40cf-9d3f-72a1120c712d"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"combinator":"and","conditions":[{"leftValue":"={{ $json.is_ingested }}","rightValue":true,"operator":{"type":"boolean","operation":"notTrue"}}]}},"name":"ğŸ†• Noch nicht ingestiert?","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1000,400],"id":"9e35ee71-f7c4-4d20-8119-c05abcc21ab7"},{"parameters":{"jsCode":"// Text-Extraktion basierend auf Dateityp\nconst fs = require('fs');\nconst { execSync } = require('child_process');\n\nconst filePath = $('ğŸ“‹ Has Files?').first().json.filePath;\nconst sourceType = $('ğŸ“‹ Has Files?').first().json.sourceType;\nconst fileName = $('ğŸ“‹ Has Files?').first().json.fileName;\nconst fileHash = $('ğŸ“‹ Has Files?').first().json.fileHash;\nconst modifiedAt = $('ğŸ“‹ Has Files?').first().json.modifiedAt;\n\nlet content = '';\n\ntry {\n  if (sourceType === 'txt' || sourceType === 'md') {\n    content = fs.readFileSync(filePath, 'utf-8');\n  } else if (sourceType === 'pdf') {\n    // pdf-parse in eigenem Node-Prozess (n8n Sandbox freezt Prototypen)\n    const result = execSync(\n      'node /home/node/eddy-inbox/scripts/pdf-extract.js \"' + filePath.replace(/\"/g, '\\\\\"') + '\"',\n      { timeout: 30000, encoding: 'utf-8', maxBuffer: 10 * 1024 * 1024 }\n    );\n    const parsed = JSON.parse(result.trim());\n    if (parsed.error) throw new Error('PDF parse: ' + parsed.error);\n    content = parsed.text || '';\n  } else if (sourceType === 'docx') {\n    content = '[DOCX extraction not yet supported]';\n  }\n\n  if (!content || content.trim().length < 10) {\n    return [{ json: { error: 'No content extracted', fileName, sourceType } }];\n  }\n\n  return [{\n    json: {\n      content: content.trim(),\n      fileName, filePath, sourceType, fileHash, modifiedAt,\n      contentLength: content.trim().length\n    }\n  }];\n} catch (err) {\n  return [{ json: { error: err.message, fileName, sourceType } }];\n}"},"name":"ğŸ“„ Text Extraction","type":"n8n-nodes-base.code","typeVersion":2,"position":[1220,400],"id":"34de3c90-2b5b-4125-9935-61cb42459a41"},{"parameters":{"jsCode":"// Chunking mit Overlap\nconst CHUNK_SIZE = 500;     // ~500 Token\nconst OVERLAP = 100;        // ~200 Token\n\nconst content = $json.content || '';\nconst fileName = $json.fileName;\nconst sourceType = $json.sourceType;\nconst fileHash = $json.fileHash;\nconst modifiedAt = $json.modifiedAt;\n\nconst crypto = require('crypto');\n\nif (!content || content.length < 10) {\n  return [{ json: { error: 'No content to chunk', fileName } }];\n}\n\nconst chunks = [];\nlet startIndex = 0;\nlet chunkIndex = 0;\n\nwhile (startIndex < content.length) {\n  let endIndex = Math.min(startIndex + CHUNK_SIZE, content.length);\n  \n  // Versuche am Satzende zu brechen\n  if (endIndex < content.length) {\n    const lastPeriod = content.lastIndexOf('.', endIndex);\n    const lastNewline = content.lastIndexOf('\\n', endIndex);\n    const breakPoint = Math.max(lastPeriod, lastNewline);\n    if (breakPoint > startIndex + CHUNK_SIZE * 0.5) {\n      endIndex = breakPoint + 1;\n    }\n  }\n  \n  const chunkText = content.slice(startIndex, endIndex).trim();\n  \n  if (chunkText.length > 20) {\n    const chunkHash = crypto.createHash('sha256').update(chunkText).digest('hex');\n    chunks.push({\n      json: {\n        chunk_content: chunkText,\n        chunk_hash: chunkHash,\n        chunk_index: chunkIndex,\n        source_file: fileName,\n        source_type: sourceType,\n        file_hash: fileHash,\n        modified_at: modifiedAt\n      }\n    });\n    chunkIndex++;\n  }\n  \n  if (endIndex >= content.length) break;\n  startIndex = endIndex - OVERLAP;\n}\n\nconst totalChunks = chunks.length;\nchunks.forEach(c => c.json.total_chunks = totalChunks);\n\nreturn chunks;"},"name":"ğŸ”ª Chunking (800/320)","type":"n8n-nodes-base.code","typeVersion":2,"position":[1440,400],"id":"283113a0-6323-48a7-9762-8e53a2f63355"},{"parameters":{"method":"POST","url":"http://n8n-ollama:11434/api/embeddings","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ model: 'mxbai-embed-large', prompt: 'search_document: ' + $json.chunk_content }) }}","options":{"timeout":900000,"retryOnFailure":true,"maxRetries":3,"waitBetweenRetries":5000}},"name":"ğŸ§¬ Embedding (mxbai)","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2000,300],"id":"78467c42-1ba9-4e5c-adc2-063e3296db8b"},{"parameters":{"operation":"executeQuery","query":"INSERT INTO document_chunks (content, content_hash, embedding, source_file, source_type, file_hash, chunk_index, total_chunks, source_modified_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9) ON CONFLICT (content_hash) DO NOTHING RETURNING id;","options":{"queryReplacement":"={{ [$node['ğŸ”„ Batch Loop'].json.chunk_content, $node['ğŸ”„ Batch Loop'].json.chunk_hash, '[' + $json.embedding.join(',') + ']', $node['ğŸ”„ Batch Loop'].json.source_file, $node['ğŸ”„ Batch Loop'].json.source_type, $node['ğŸ”„ Batch Loop'].json.file_hash, $node['ğŸ”„ Batch Loop'].json.chunk_index, $node['ğŸ”„ Batch Loop'].json.total_chunks, $node['ğŸ”„ Batch Loop'].json.modified_at] }}"}},"name":"ğŸ’¾ Store in pgvector","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[2200,300],"credentials":{"postgres":{"id":"Jq2IeHXVMOnpk0fI","name":"eddy-knowledge-postgres"}},"id":"98c54b9f-074d-4739-88be-1c3888c9ed61"},{"parameters":{"jsCode":"// Datei von pending nach processed verschieben\nconst fs = require('fs');\nconst path = require('path');\n\nconst filePath = $('ğŸ“‹ Has Files?').first().json.filePath;\nconst fileName = $('ğŸ“‹ Has Files?').first().json.fileName;\nconst processedDir = '/home/node/eddy-inbox/processed';\n\ntry {\n  if (!fs.existsSync(processedDir)) {\n    fs.mkdirSync(processedDir, { recursive: true });\n  }\n  \n  const dest = path.join(processedDir, fileName);\n  fs.renameSync(filePath, dest);\n  \n  return [{\n    json: {\n      status: 'success',\n      fileName,\n      movedTo: dest,\n      chunks_created: $items().length\n    }\n  }];\n} catch (err) {\n  const failedDir = '/home/node/eddy-inbox/failed';\n  try {\n    if (!fs.existsSync(failedDir)) fs.mkdirSync(failedDir, { recursive: true });\n    fs.renameSync(filePath, path.join(failedDir, fileName));\n  } catch (e) { /* ignore */ }\n  \n  return [{ json: { status: 'error', error: err.message, fileName } }];\n}"},"name":"ğŸ“ Move to Processed","type":"n8n-nodes-base.code","typeVersion":2,"position":[2000,600],"id":"c95c59f6-3ca6-4482-8631-8ee07cd232f8"},{"parameters":{"jsCode":"// Webhook-Pfad: Content direkt chunken\nconst crypto = require('crypto');\n\nconst content = $json.body.content || '';\nconst metadata = $json.body.metadata || {};\nconst fileName = metadata.source_file || 'webhook-input';\nconst sourceType = metadata.source_type || 'txt';\nconst category = metadata.category || null;\nconst tags = metadata.tags || [];\nconst fileHash = crypto.createHash('sha256').update(content).digest('hex');\n\nconst CHUNK_SIZE = 500;\nconst OVERLAP = 100;\n\nif (!content || content.trim().length < 10) {\n  return [{ json: { error: 'No content provided' } }];\n}\n\nconst chunks = [];\nlet startIndex = 0;\nlet chunkIndex = 0;\nconst trimmed = content.trim();\n\nwhile (startIndex < trimmed.length) {\n  let endIndex = Math.min(startIndex + CHUNK_SIZE, trimmed.length);\n  \n  if (endIndex < trimmed.length) {\n    const lastPeriod = trimmed.lastIndexOf('.', endIndex);\n    const lastNewline = trimmed.lastIndexOf('\\n', endIndex);\n    const breakPoint = Math.max(lastPeriod, lastNewline);\n    if (breakPoint > startIndex + CHUNK_SIZE * 0.5) {\n      endIndex = breakPoint + 1;\n    }\n  }\n  \n  const chunkText = trimmed.slice(startIndex, endIndex).trim();\n  \n  if (chunkText.length > 20) {\n    const chunkHash = crypto.createHash('sha256').update(chunkText).digest('hex');\n    chunks.push({\n      json: {\n        chunk_content: chunkText,\n        chunk_hash: chunkHash,\n        chunk_index: chunkIndex,\n        source_file: fileName,\n        source_type: sourceType,\n        file_hash: fileHash,\n        category: category,\n        tags: tags\n      }\n    });\n    chunkIndex++;\n  }\n  \n  if (endIndex >= trimmed.length) break;\n  startIndex = endIndex - OVERLAP;\n}\n\nconst totalChunks = chunks.length;\nchunks.forEach(c => c.json.total_chunks = totalChunks);\n\nreturn chunks;"},"name":"ğŸ”ª Webhook Chunking","type":"n8n-nodes-base.code","typeVersion":2,"position":[560,850],"id":"d6bf7c64-b07c-411b-a583-ade8afc71816"},{"parameters":{"method":"POST","url":"http://n8n-ollama:11434/api/embeddings","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ model: 'mxbai-embed-large', prompt: 'search_document: ' + $json.chunk_content }) }}","options":{"timeout":300000}},"name":"ğŸ§¬ WH Embedding","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[780,850],"id":"440b24c4-74e6-41ba-bd0f-91bc6e070f9b"},{"parameters":{"operation":"executeQuery","query":"INSERT INTO document_chunks (content, content_hash, embedding, source_file, source_type, file_hash, chunk_index, total_chunks, category, tags) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10) ON CONFLICT (content_hash) DO NOTHING RETURNING id;","options":{"queryReplacement":"={{ [$node['ğŸ”ª Webhook Chunking'].json.chunk_content, $node['ğŸ”ª Webhook Chunking'].json.chunk_hash, '[' + $json.embedding.join(',') + ']', $node['ğŸ”ª Webhook Chunking'].json.source_file, $node['ğŸ”ª Webhook Chunking'].json.source_type, $node['ğŸ”ª Webhook Chunking'].json.file_hash, $node['ğŸ”ª Webhook Chunking'].json.chunk_index, $node['ğŸ”ª Webhook Chunking'].json.total_chunks, $node['ğŸ”ª Webhook Chunking'].json.category || null, $node['ğŸ”ª Webhook Chunking'].json.tags ? '{' + $node['ğŸ”ª Webhook Chunking'].json.tags.join(',') + '}' : null] }}"}},"name":"ğŸ’¾ WH Store","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[1000,850],"credentials":{"postgres":{"id":"Jq2IeHXVMOnpk0fI","name":"eddy-knowledge-postgres"}},"id":"8a0362d7-f1c6-4110-9e60-d3e9e413f854"},{"parameters":{"respondWith":"json","responseBody":"={{ $items().length > 0 && $node['ğŸ”ª Webhook Chunking'].first() ? { status: 'success', chunks_ingested: $items().length, source: $node['ğŸ”ª Webhook Chunking'].first().json.source_file || 'unknown' } : { status: 'error', message: 'No chunks created or missing source file' } }}","options":{}},"name":"âœ… WH Response","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1220,850],"id":"c2f848b1-57e3-42b7-8b0c-0ab9bccb8b1a"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"combinator":"and","conditions":[{"leftValue":"={{ $json.body.action }}","rightValue":"ask","operator":{"type":"string","operation":"equals"}}]}},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"combinator":"and","conditions":[{"leftValue":"={{ $json.body.action }}","rightValue":"ingest","operator":{"type":"string","operation":"equals"}}]}}]},"fallback":"output"},"id":"action-router-node","name":"ğŸ¯ Action Router","type":"n8n-nodes-base.switch","typeVersion":3,"position":[340,700]},{"parameters":{"method":"POST","url":"http://n8n-ollama:11434/api/embeddings","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ model: 'mxbai-embed-large', prompt: 'search_query: ' + $json.body.query }) }}","options":{"timeout":300000}},"id":"query-embed-node","name":"ğŸ” Query Embedding","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[560,600]},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM hybrid_search($1, $2, $3, $4, $5);","options":{"queryReplacement":"={{ ['[' + $json.embedding.join(',') + ']', $node['ğŸ¯ Action Router'].json.body.query, 5, 0.7, null] }}"}},"id":"hybrid-search-node","name":"ğŸ—„ï¸ Hybrid Search","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[780,600],"credentials":{"postgres":{"id":"Jq2IeHXVMOnpk0fI","name":"eddy-knowledge-postgres"}}},{"parameters":{"jsCode":"const items = $input.all();\nif (items.length === 0 || !items[0].json.content) {\n    return [{json: {context: \"Keine relevanten Informationen gefunden.\", query: $('ğŸ¯ Action Router').first().json.body.query}}];\n}\nconst context = items.map(item => `--- Dokument: ${item.json.source_file} ---\n${item.json.content}`).join('\\n\\n');\nconst query = $('ğŸ¯ Action Router').first().json.body.query;\nreturn [{ json: { context: context, query: query } }];"},"id":"context-format-node","name":"ğŸ“ Format Context","type":"n8n-nodes-base.code","typeVersion":2,"position":[1000,600]},{"parameters":{"method":"POST","url":"http://n8n-ollama:11434/api/generate","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ model: 'llama3.2', prompt: 'Du bist Eddy, ein technischer Assistent. Beantworte die Frage prÃ¤zise basierend auf dem folgenden Kontext. Wenn die Antwort nicht im Kontext steht, sage das ehrlich.\\n\\nKONTEXT:\\n' + $json.context + '\\n\\nFRAGE: ' + $json.query + '\\n\\nANTWORT:', stream: false }) }}","options":{"timeout":120000}},"id":"ollama-chat-node","name":"ğŸ¤– Ollama Chat","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1220,600]},{"parameters":{"respondWith":"json","responseBody":"={{ { answer: $json.response, context_used: $node['ğŸ“ Format Context'].json.context.length > 50 } }}","options":{}},"id":"ask-response-node","name":"ğŸ“¤ Ask Response","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1440,600]},{"parameters":{"batchSize":1,"options":{}},"id":"split-batches-node-v12","name":"ğŸ”„ Batch Loop","type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[1800,400]}],"connections":{"ğŸ“‚ Scan Inbox":{"main":[[{"node":"ğŸ“‹ Has Files?","type":"main","index":0}]]},"ğŸ“‹ Has Files?":{"main":[[{"node":"ğŸ” Duplikat-Check","type":"main","index":0}],[]]},"ğŸ” Duplikat-Check":{"main":[[{"node":"ğŸ†• Noch nicht ingestiert?","type":"main","index":0}]]},"ğŸ†• Noch nicht ingestiert?":{"main":[[],[{"node":"ğŸ“„ Text Extraction","type":"main","index":0}]]},"ğŸ“„ Text Extraction":{"main":[[{"node":"ğŸ”ª Chunking (800/320)","type":"main","index":0}]]},"ğŸŒ Webhook Ingest":{"main":[[{"node":"ğŸ¯ Action Router","type":"main","index":0}]]},"ğŸ”ª Webhook Chunking":{"main":[[{"node":"ğŸ§¬ WH Embedding","type":"main","index":0}]]},"ğŸ§¬ WH Embedding":{"main":[[{"node":"ğŸ’¾ WH Store","type":"main","index":0}]]},"ğŸ’¾ WH Store":{"main":[[{"node":"âœ… WH Response","type":"main","index":0}]]},"Manual Trigger":{"main":[[{"node":"ğŸ“‚ Scan Inbox","type":"main","index":0}]]},"ğŸ¯ Action Router":{"main":[[{"node":"ğŸ” Query Embedding","type":"main","index":0}],[{"node":"ğŸ”ª Webhook Chunking","type":"main","index":0}],[{"node":"ğŸ”ª Webhook Chunking","type":"main","index":0}]]},"ğŸ” Query Embedding":{"main":[[{"node":"ğŸ—„ï¸ Hybrid Search","type":"main","index":0}]]},"ğŸ—„ï¸ Hybrid Search":{"main":[[{"node":"ğŸ“ Format Context","type":"main","index":0}]]},"ğŸ“ Format Context":{"main":[[{"node":"ğŸ¤– Ollama Chat","type":"main","index":0}]]},"ğŸ¤– Ollama Chat":{"main":[[{"node":"ğŸ“¤ Ask Response","type":"main","index":0}]]},"ğŸ”ª Chunking (800/320)":{"main":[[{"node":"ğŸ”„ Batch Loop","type":"main","index":0}]]},"ğŸ”„ Batch Loop":{"main":[[{"node":"ğŸ“ Move to Processed","type":"main","index":0}],[{"node":"ğŸ§¬ Embedding (mxbai)","type":"main","index":0}]]},"ğŸ§¬ Embedding (mxbai)":{"main":[[{"node":"ğŸ’¾ Store in pgvector","type":"main","index":0}]]},"ğŸ’¾ Store in pgvector":{"main":[[{"node":"ğŸ”„ Batch Loop","type":"main","index":0}]]}},"authors":"Birger Baron","name":null,"description":null,"autosaved":false,"workflowPublishHistory":[{"createdAt":"2026-02-09T20:55:16.957Z","id":176,"workflowId":"z4re03A65oXIt7Wz","versionId":"4af0ed14-3ae2-4e67-be86-46310b3df4f6","event":"activated","userId":"cc1af505-66f4-4ef5-9b31-0821ef636557"}]}}